<!-- build time:Fri May 22 2020 10:58:11 GMT+0000 (Coordinated Universal Time) --><!DOCTYPE html><html><head><meta charset="utf-8"><title>mysql | Zhy Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="存储引擎存储引擎：数据在计算机上存储的方式MySQL 常见的存储引擎：InnoDB、MyISAM等InnoDB 的优势在于提供了良好的事务处理、崩溃修复能力和并发控制。缺点是读写效率较差，占用的数据空间相对较大MyISAM 的优势在于占用空间小，处理速度快。缺点是不支持事务的完整性和并发性"><meta property="og:type" content="article"><meta property="og:title" content="mysql"><meta property="og:url" content="https:&#x2F;&#x2F;liserlzhy.github.io&#x2F;2019&#x2F;12&#x2F;30&#x2F;database&#x2F;mysql&#x2F;index.html"><meta property="og:site_name" content="Zhy Blog"><meta property="og:description" content="存储引擎存储引擎：数据在计算机上存储的方式MySQL 常见的存储引擎：InnoDB、MyISAM等InnoDB 的优势在于提供了良好的事务处理、崩溃修复能力和并发控制。缺点是读写效率较差，占用的数据空间相对较大MyISAM 的优势在于占用空间小，处理速度快。缺点是不支持事务的完整性和并发性"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-05-22T10:57:54.274Z"><meta name="twitter:card" content="summary"><link rel="alternate" href="/blog/atom.xml" title="Zhy Blog" type="application/atom+xml"><link rel="icon" href="/blog/css/images/logo.png"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/blog/css/style.css"><meta name="generator" content="Hexo 4.0.0"></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="slideout-menu"><ul><li><a class="main-nav-link" href="/blog/">首页</a></li><li><a class="main-nav-link" href="/blog/archives">归档</a></li><li><a class="main-nav-link" href="/blog/favorite">收藏</a></li><li><div class="site_search"><div class="form-group"><input type="text" id="slidedown-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"></div><div id="slidedown-search-result"></div></div></li></ul></div><nav id="header-nav"><div id="logo-img"><label class="on-off noselect" for="on-off"><input id="on-off" type="checkbox" onchange='return window.location="/blog/"'> <span class="on-off-circle"></span></label></div><div id="menu-icon"><a class="icon icon-bars"></a></div><ul><li><a class="main-nav-link" href="/blog/">首页</a></li><li><a class="main-nav-link" href="/blog/archives">归档</a></li><li><a class="main-nav-link" href="/blog/favorite">收藏</a></li><li><div id="search-icon"><a class="icon icon-search" title="搜索"></a></div></li></ul></nav><div class="site_search"><div><input type="text" id="nav-search-input" name="q" results="0" placeholder="搜索"></div><div id="nav-search-result"></div></div></header><div class="outer"><div class="toc-post"><div id="toc" class="toc-article"><span id="toc-icon" class="icon icon-chevron-right"></span><div id="toc-box"><div class="toc-title">mysql</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#存储引擎"><span class="toc-text">存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库"><span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#字符集、编码"><span class="toc-text">字符集、编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据校对"><span class="toc-text">数据校对</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据类型"><span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主键-PRIMARY-KEY"><span class="toc-text">主键 (PRIMARY KEY)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引-INDEX"><span class="toc-text">索引 (INDEX)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#命令语句"><span class="toc-text">命令语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sequelize"><span class="toc-text">Sequelize</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关联查询与预加载"><span class="toc-text">关联查询与预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库迁移"><span class="toc-text">数据库迁移</span></a></li></ol></div></div><article id="post-database/mysql" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><time class="article-date" datetime="2019-12-30T09:01:16.000Z" itemprop="datePublished">2019-12-30</time><div class="article-category"><a class="article-category-link" href="/blog/categories/database/">database</a></div></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">mysql</h1></header><div class="article-entry" itemprop="articleBody"><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>存储引擎：数据在计算机上存储的方式</p><p>MySQL 常见的存储引擎：InnoDB、MyISAM等</p><ul><li><p>InnoDB 的优势在于提供了良好的事务处理、崩溃修复能力和并发控制。缺点是读写效率较差，占用的数据空间相对较大</p></li><li><p>MyISAM 的优势在于占用空间小，处理速度快。缺点是不支持事务的完整性和并发性</p><a id="more"></a><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2></li></ul><h3 id="字符集、编码"><a href="#字符集、编码" class="headerlink" title="字符集、编码"></a>字符集、编码</h3><ul><li>指数据库存储的数据的编码</li><li>utf8mb4 : 支持更多的 unicode 字符（四字节）</li><li>_bin、_cs : 区分大小写</li><li>_ci : 不区分大小写</li></ul><h3 id="数据校对"><a href="#数据校对" class="headerlink" title="数据校对"></a>数据校对</h3><ul><li><p>数据库除了要存储数据，还要对数据进行排序，比较等操作，不同的校对规则会有不同的结果</p></li><li><p>utf8mb4_unicode_ci : 基于标准的 Unicode 来排序和比较，能够在各种语言和之间精确排序</p></li></ul><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>数字类型</p><table><thead><tr><th align="left">类型</th><th align="left">存储 (字节)</th></tr></thead><tbody><tr><td align="left">TINYINT</td><td align="left">1</td></tr><tr><td align="left">SMALLINT</td><td align="left">2</td></tr><tr><td align="left">MEDIUMINT</td><td align="left">3</td></tr><tr><td align="left">INT</td><td align="left">4</td></tr><tr><td align="left">BIGINT</td><td align="left">8</td></tr></tbody></table><p>字符串类型</p><table><thead><tr><th align="left">类型</th><th align="left">存储 (字节)</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">char(n)</td><td align="left">n</td><td align="left">定长字节：指定多少字节就为多少字节，(n为数字，范围：0-255)</td></tr><tr><td align="left">varchar(n)</td><td align="left">n</td><td align="left">不定长字节：长度跟存储的数据相匹配，最大n字节。(n为数字，范围：0-255)</td></tr></tbody></table><h3 id="主键-PRIMARY-KEY"><a href="#主键-PRIMARY-KEY" class="headerlink" title="主键 (PRIMARY KEY)"></a>主键 (PRIMARY KEY)</h3><p>表中的一个或多个字段，它的值用于唯一地标识表中的某一条记录，用来保持数据的完整性</p><p>特定：</p><ul><li>一个表中只能有一个主键</li><li>主键可以是一个字段，也可以由多个字段组成</li><li>主键值不能重复</li><li>可加快对数据的操作</li></ul><h3 id="索引-INDEX"><a href="#索引-INDEX" class="headerlink" title="索引 (INDEX)"></a>索引 (INDEX)</h3><p>对表中一列或者多列的值进行排序的一种结构，使用索引可以加快访问表中特定的信息，加快对表中记录的查找或排序</p><h2 id="命令语句"><a href="#命令语句" class="headerlink" title="命令语句"></a>命令语句</h2><p>连接数据库</p><pre><code>-- 可使用 --host 参数连接外部数据库
mysql -uroot -p </code></pre><p>授权</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 运行外部主机连接到mysql服务器，需要授权</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> 库名.表名 <span class="keyword">to</span> <span class="string">'用户名'</span>@<span class="string">'IP地址'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'密码'</span> <span class="keyword">with</span> <span class="keyword">grant</span> <span class="keyword">option</span>;</span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure><p>创建数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> 数据库名称 <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_bin;</span><br></pre></td></tr></table></figure><p>删除数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> 数据库名称;</span><br></pre></td></tr></table></figure><p>创建表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 比较完整的表创建</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user2 (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  username <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  age <span class="built_in">TINYINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  gender ENUM(<span class="string">'男'</span>, <span class="string">'女'</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'男'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>),</span><br><span class="line">  <span class="keyword">INDEX</span> uname(username),</span><br><span class="line">  <span class="keyword">INDEX</span> age(age)</span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_bin;</span><br></pre></td></tr></table></figure><p>插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (username, age) <span class="keyword">VALUES</span> (<span class="string">'Tom'</span>, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入多条数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (username, age, gender) <span class="keyword">VALUES</span> (<span class="string">'Mane'</span>, <span class="number">22</span>, <span class="string">'男'</span>),(<span class="string">'Jone'</span>, <span class="number">20</span>, <span class="string">'女'</span>);</span><br></pre></td></tr></table></figure><p>更新数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> age=<span class="number">13</span>,gender=<span class="string">'女'</span> <span class="keyword">WHERE</span> username=<span class="string">'Tom'</span>;</span><br></pre></td></tr></table></figure><p>修改表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- TO/AS 都可以</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">RENAME</span> <span class="keyword">TO</span> <span class="keyword">users</span>;</span><br></pre></td></tr></table></figure><p>删除表数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- DELETE 删除表的数据，保留结构，支持事务</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- TRUNCATE 删除表的数据，保留结构，不支持事务，不可撤销恢复</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p>删除表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p>查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询所有数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询某个字段</span></span><br><span class="line"><span class="keyword">SELECT</span> username <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询去重</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> gender <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p>分组</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> gender, <span class="keyword">count</span>(gender) <span class="keyword">as</span> <span class="keyword">count</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> gender;</span><br></pre></td></tr></table></figure><p>条件查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- &gt;、&gt;=、&lt;&gt;、&lt;、&lt;=、AND、OR、LIKE、BETWEEN、LIKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- BETWEEN 查询在某个区间的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> age <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">20</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- LIKE 模糊查询，'%B%'(包含B),'B%'(B开头)，'%B'(B结尾)，'_o%'(下划线表示单个字符)</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> <span class="string">'B%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span>　<span class="keyword">user</span> <span class="keyword">WHERE</span> username <span class="keyword">IN</span> (<span class="string">'Tom'</span>, <span class="string">'Jone'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> username REGEXP <span class="string">'e$'</span>;</span><br></pre></td></tr></table></figure><p>排序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- DESC 降序， </span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><p>限制和偏移</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 从第二条数据开始查询两条</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">LIMIT</span> <span class="number">2</span> <span class="keyword">OFFSET</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 上面的语句可简写为</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">LIMIT</span> <span class="number">1</span>,<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：ORDER BY 必须在 LIMIT 之前 WHERE(GROUP BY)之后</span></span><br></pre></td></tr></table></figure><p>函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- count、sum、avg、lcase、ucase、len ...</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> <span class="keyword">UCASE</span>(usrename)=<span class="keyword">UCASE</span>(<span class="string">'tom'</span>)</span><br></pre></td></tr></table></figure><p>联合查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span>, message <span class="keyword">WHERE</span> user.id = message.uid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> message (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  uid <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">content</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_bin;</span><br></pre></td></tr></table></figure><p>多表查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 下面的语句结果跟内连接一样</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span>, message <span class="keyword">WHERE</span> user.id = message.uid;</span><br></pre></td></tr></table></figure><p>内连接</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">JOIN</span> message <span class="keyword">ON</span> user.id = message.uid</span><br></pre></td></tr></table></figure><p>左连接</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> message <span class="keyword">ON</span> user.id = message.uid;</span><br></pre></td></tr></table></figure><h2 id="Sequelize"><a href="#Sequelize" class="headerlink" title="Sequelize"></a>Sequelize</h2><p>Sequelize 是一个基于 promise 的 Node.js ORM (Object Relational Mapping)，目前支持 Postgres, MySQL，SQLite 和 Microsoft SQL Server。它具有强大的事务支持，关联关系，读取和复制等功能</p><pre><code>npm i sequelize mysql2</code></pre><p>模型对象.save()</p><ul><li>验证该实例，如果通过验证，则持久化到数据库中</li></ul><p>模型对象.update(updates:Object)</p><ul><li>要更新的字段，调用该方法等同于调用.set()然后.save()</li></ul><p>模型对象.destroy()</p><ul><li>销毁该实例</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">'sequelize'</span>)</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  database: <span class="string">'test'</span>, </span><br><span class="line">  username: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">''</span>,</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  port: <span class="number">3306</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建sequelize对象实例</span></span><br><span class="line"><span class="comment">// const sequelize = new Sequelize('mysql://localhost:3306/database', &#123;&#125;) //url 形式</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(config.database, config.username, config.password, &#123;</span><br><span class="line">  host: config.host,</span><br><span class="line">  dialect: <span class="string">'mysql'</span>,</span><br><span class="line">  pool: &#123;</span><br><span class="line">    max: <span class="number">5</span>,</span><br><span class="line">    min: <span class="number">0</span>,</span><br><span class="line">    idle: <span class="number">30000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize.authenticate().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'连接失败'</span>)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'连接失败'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义模型</span></span><br><span class="line"><span class="keyword">const</span> UserModel = sequelize.define(<span class="string">'User'</span>, &#123;</span><br><span class="line">  id: &#123;</span><br><span class="line">    type: Sequelize.INTEGER(<span class="number">11</span>),</span><br><span class="line">    allowNull: <span class="literal">false</span>,</span><br><span class="line">    autoIncrement: <span class="literal">true</span>,</span><br><span class="line">    primaryKey: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  username: &#123;</span><br><span class="line">    type: Sequelize: STRING(<span class="number">50</span>),</span><br><span class="line">    allowNull: <span class="literal">false</span>, <span class="comment">// 所有字段默认为 true</span></span><br><span class="line">    defaultValue: <span class="string">''</span></span><br><span class="line">  &#125;,</span><br><span class="line">  age: &#123;</span><br><span class="line">    type: Sequelize.TINYINT,</span><br><span class="line">    allowNull: <span class="literal">false</span>,</span><br><span class="line">    defaultValue: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  gender: &#123;</span><br><span class="line">    type: Sequelize.ENUM(<span class="string">'男'</span>, <span class="string">'女'</span>),</span><br><span class="line">    allowNull:<span class="literal">false</span>,</span><br><span class="line">    defaultValue: <span class="string">'男'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  timeStamps: <span class="literal">false</span>, <span class="comment">// 是否给每条记录添加createdAt 会 updatedAt 字段，并在添加新数据和更新数据的时候自动设置这两个字段的值，默认为 true</span></span><br><span class="line">  tableName: <span class="string">'user'</span>, <span class="comment">// 手动设置表的实际名称</span></span><br><span class="line">  paranoid: <span class="literal">false</span>,<span class="comment">// 设置 deletedAt 字段，当删除记录的时候，并不是真的烧毁记录，而是通过该字段来标志，即保留数据，进行假删除，默认为 false</span></span><br><span class="line">  indexes: [</span><br><span class="line">    &#123;</span><br><span class="line">      uname: <span class="string">'uname'</span>,</span><br><span class="line">      field: [<span class="string">'username'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'age'</span>,</span><br><span class="line">      fields: [<span class="string">'age'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建数据</span></span><br><span class="line"><span class="comment">// let tom = new UserModel()</span></span><br><span class="line"><span class="comment">// 通过new 或者 build出来的对象不会立即同步到数据库中，需要辅助其他函数</span></span><br><span class="line"><span class="keyword">let</span> tom = UserModel.build(&#123; <span class="comment">// UserModel.create</span></span><br><span class="line">  username: <span class="string">'Tom'</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  gender: <span class="string">'男'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">tom.set(<span class="string">'age'</span>, <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">tom.save()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找数据</span></span><br><span class="line"><span class="keyword">let</span> fa = <span class="keyword">await</span> User.findAll(&#123;</span><br><span class="line">  where: &#123;</span><br><span class="line">    <span class="comment">// age: 18, //等同于 age: &#123;[Sequelize.Op.eq]: 18&#125;</span></span><br><span class="line">    <span class="comment">// limit: 2, </span></span><br><span class="line">    <span class="comment">// offset: 2,</span></span><br><span class="line">    <span class="comment">// order: [['age','desc']],</span></span><br><span class="line">    [Sequelize.Op.or]: [ <span class="comment">// 多条件</span></span><br><span class="line">      &#123;</span><br><span class="line">        age: &#123;[Sequelize.Op.gt]: <span class="number">30</span>&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        gender: <span class="string">'女'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">    &#125; </span><br><span class="line">  </span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">await</span> UserModel.findOne(&#123;<span class="attr">where</span>: &#123;<span class="attr">username</span>: <span class="string">'Tom'</span>&#125;&#125;)</span><br><span class="line"><span class="keyword">let</span> count = <span class="keyword">await</span> UserModel.count()</span><br><span class="line"><span class="keyword">let</span> cf = <span class="keyword">await</span> UserModel.findAndCountAll(&#123;<span class="attr">limit</span>: <span class="number">2</span>&#125;)</span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line"><span class="keyword">let</span> t = <span class="keyword">await</span> UserModel.findByPk(<span class="number">1</span>)</span><br><span class="line">t.set(<span class="string">'age'</span>, <span class="number">20</span>)</span><br><span class="line"><span class="keyword">await</span> t.save()</span><br><span class="line"></span><br><span class="line"><span class="comment">// await t.update(&#123;age: 20&#125;) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="comment">// t.destroy()</span></span><br></pre></td></tr></table></figure><h2 id="关联查询与预加载"><a href="#关联查询与预加载" class="headerlink" title="关联查询与预加载"></a>关联查询与预加载</h2><pre><code>HasOne: model1.hasOne(model2) // 1对1
HasMany: model1.hasMany(model2) // 1对多
BelongsTo: model1.belongsTo(model2) // 属于
BelongsToMany: model1.belongsToMany(model2)

model1.findOne({include[model2])</code></pre><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 设置外键关系</span></span><br><span class="line">uid: &#123;</span><br><span class="line">  type: Sequelize.INTEGER(<span class="number">10</span>),</span><br><span class="line">  defaultValue: <span class="number">0</span>,</span><br><span class="line">  references: &#123;</span><br><span class="line">    model: UserModel,</span><br><span class="line">    key: <span class="string">'id'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MessageModel.belongsTo(UserModel, &#123;</span><br><span class="line">  foreignKey: uid</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = <span class="keyword">await</span> MessageModel.findByPk(<span class="number">1</span>, &#123;<span class="attr">include</span>: [UserModel]&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(data.User.username)</span><br><span class="line"></span><br><span class="line">UserModel.hasMany(MessageModel, &#123;</span><br><span class="line">  foreignKey: <span class="string">'uid'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> data2 = <span class="keyword">await</span> UserModel.findByPk(<span class="number">3</span>, &#123;</span><br><span class="line">  include: [MessageModel]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h2><p>就像git一样，我们可以使用Sequelize迁移来帮助我们跟踪数据库的更改，并在各个不同时期的数据库状态之间进行切换</p><p>使用Sequelize迁移，需要安装sequelize-cli工具，sequelize-cli依赖sequelize</p><p>安装</p><pre><code>npm i sequelize-cli
npm i sequelize</code></pre><p>初始化</p><pre><code>&gt; sequelize init
初始化sequelize项目，该命令将创建如下目录：
  - config: 包含配置文件，它告诉CLI如何连接数据库
  - models: 
  - migrations: 包含所有迁移文件
  - seeders: 包含所有的种子文件</code></pre><p>创建/删除数据库</p><pre><code>根据配置创建或删除数据库
&gt; sequelize db:create  
&gt; sequelize db:drop</code></pre><p>配置环境变量</p><pre><code>set NODE_ENV=test
echo %NODE_ENV%

还原原来的开发环境
set NODE_ENV=</code></pre><p>创建模型</p><pre><code>&gt; sequelize model:generate
或者
&gt; sequelize model:create

会创建一个模型文件
--name: 模型名称，必须
--attributes: 字段列表，必须

示例：
sequelize model:create --name User --attributes username:STRING</code></pre><p>执行迁移</p><pre><code>所谓迁移，就是怼数据库进行结构的创建，升级（修改）等操作
&gt; sequelize db:migrate
  - 会在数据库中创建一个SequelizeMeta表，用于记录每次迁移记录
  - 执行migrations文件下满足玩家(SequelizeMeta表)

撤销
&gt; sequelize db:migrate:undo
  - 撤销最近的迁移操作
&gt; sequelize db:migrate:undo:all
  - 撤销所有的迁移操作
&gt; sequelize db:migrate:undo --name
  - 撤销具体迁移脚本</code></pre><p>添加新字段</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  up: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.addColumn(</span><br><span class="line">      <span class="string">'users'</span>, </span><br><span class="line">      <span class="string">'age'</span>, </span><br><span class="line">      &#123;</span><br><span class="line">        type: Sequelize.TINYINT,</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">        defaultValue: <span class="number">0</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  down: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.removeColum(<span class="string">'users'</span>,<span class="string">'age'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>种子</p><pre><code>创建种子文件
&gt; sequelize seed:create --name userTest

运行种子文件
&gt; sequelize db:seed:all

撤销
&gt; sequelize db:seed:undo:all</code></pre><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  up: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 插入测试数据</span></span><br><span class="line">    <span class="keyword">return</span> queryInterface.bulkInsert(<span class="string">'users'</span>, [</span><br><span class="line">      &#123;</span><br><span class="line">        username: <span class="string">'Tom'</span>,</span><br><span class="line">        age: <span class="number">12</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        username: <span class="string">'Jane'</span>,</span><br><span class="line">        age: <span class="number">14</span></span><br><span class="line">      &#125;</span><br><span class="line">    ])</span><br><span class="line">  &#125;,</span><br><span class="line">  down: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.bulkDelete(<span class="string">'users'</span>,<span class="literal">null</span>, &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="article-footer"><a data-url="https://liserlzhy.github.io/2019/12/30/database/mysql/" data-id="ckai3bv7e00121wp5dxscet2d" class="article-share-link">Share</a></footer></div><nav id="article-nav"><a href="/blog/2020/01/18/others/typescript/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">TypeScript</div></a><a href="/blog/2019/12/28/vue/vue-core/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">vue 的核心原理</div></a></nav></article></div><section id="comments"><div id="gitalk-container"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><div id="gitalk-container"></div><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"c384627b91fb67b4d945",clientSecret:"40bcd6212e102325b854bae964674349cc49d136",id:window.location.pathname,repo:"blog-comment",owner:"liserlzhy",admin:"liserlzhy"});gitalk.render("gitalk-container")</script></section><span id="toTopBtn" class="icon icon-angle-up"></span></div><footer id="footer"><div id="right-footer"><div id="social-media-footer"><ul><li><a href="https://github.com/liserlzhy/blog" target="_blank" rel="noopener" class="icon icon-github"></a></li></ul></div></div></footer></div></div><script src="/blog/js/jquery.min.js"></script><link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css"><script src="/blog/fancybox/jquery.fancybox.pack.js"></script><script src="/blog/js/script.js"></script><script src="/blog/js/search.js"></script><script type="text/javascript">var search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/blog/"+search_path;searchFunc(path,"slidedown-search-input","slidedown-search-result"),searchFunc(path,"nav-search-input","nav-search-result")</script></body><!-- rebuild by neat -->